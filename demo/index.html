<!doctype html>
<html lang="en" class="h-100 w-100" data-bs-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap Calendar Demo</title>
    <link href="../vendor/twbs/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../vendor/twbs/bootstrap-icons/font/bootstrap-icons.min.css" rel="stylesheet">
</head>
<body class="h-100 w-100">
<div class="d-flex justify-content-between align-items-center border-bottom border-5 px-5">
    <h1>$.fn.bsCalendar</h1>
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckTheme">
        <label class="form-check-label" for="flexSwitchCheckTheme">light / dark</label>
    </div>
</div>

<div id="calendar" data-sidebar-addons="#sidebarAddons" class="w-100 p-4" style="height: 800px">

</div>

<div id="sidebarAddons" class="mt-4 card">
    <div class="card-header">
        <h6 class="text-uppercase text-center mb-0">sidebar addons</h6>
    </div>
    <div class="card-body d-flex flex-column">
        <div class="text-uppercase text-center mb-3"><small>plugin methods</small></div>
        <button type="button" class="btn btn-primary btn-sm mb-1" data-method="refresh">Refresh</button>
        <button type="button" class="btn btn-primary btn-sm mb-1" data-method="setDate">setDate(1970-01-01, 'day')
        </button>
        <button type="button" class="btn btn-primary btn-sm mb-1" data-method="setToday">setToday</button>
        <button type="button" class="btn btn-primary btn-sm mb-1" data-method="clear">Clear</button>
        <button type="button" class="btn btn-primary btn-sm mb-1" data-method="destroy">Destroy</button>
        <div class="text-uppercase text-center mb-3"><small>query params</small></div>
    </div>

</div>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <div class="d-flex justify-content-end mb-3">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="form-floating mb-3">
                    <input name="title" type="text" class="form-control" id="floatingInputTitle"
                           placeholder="appointment title">
                    <label for="floatingInputTitle">Title</label>
                </div>
                <div class="d-flex justify-content-between align-items-center flex-nowrap mb-3">
                    <div class="form-floating flex-fill">
                        <input name="from_date" type="date" class="form-control" id="floatingInputDate"
                               placeholder="date">
                        <label for="floatingInputDate">From date</label>
                    </div>
                    <div class="mx-1"></div>
                    <div class="form-floating flex-fill">
                        <input name="to_date" type="date" class="form-control" id="floatingInputToDate"
                               placeholder="date">
                        <label for="floatingInputToDate">To date</label>
                    </div>
                </div>

                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" name="allDay" role="switch"
                           id="flexSwitchCheckDefaultAllDay">
                    <label class="form-check-label" for="flexSwitchCheckDefaultAllDay">all day</label>
                </div>

                <div class="js-hide-on-all-day">
                    <div class="d-flex justify-content-between align-items-center flex-nowrap mb-3">
                        <div class="form-floating flex-fill">
                            <input name="from_time" type="time" class="form-control" id="floatingInputTime"
                                   placeholder="date">
                            <label for="floatingInputTime">From time</label>
                        </div>
                        <div class="mx-1"></div>
                        <div class="form-floating flex-fill">
                            <input name="to_time" type="time" class="form-control" id="floatingInputToTime"
                                   placeholder="date">
                            <label for="floatingInputToTime">To time</label>
                        </div>
                    </div>
                </div>

                <div class="form-floating mb-3">
                    <textarea class="form-control" style="height:300px" name="description"
                              placeholder="Leave a comment here" id="floatingTextareaDescription"></textarea>
                    <label for="floatingTextareaDescription">Description</label>
                </div>

                <div class="form-floating mb-3">
                    <input name="link" type="text" class="form-control" id="floatingInputLink"
                           placeholder="appointment link">
                    <label for="floatingInputLink">Link</label>
                </div>

                <div class="d-flex justify-content-end align-items-center">
                    <label for="floatingInputColor" class="d-none"></label>
                    <input type="color" name="color" class="form-control me-2" id="floatingInputColor">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../vendor/components/jquery/jquery.min.js"></script>

<script src="../vendor/twbs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../dist/bs-calendar.min.js"></script>
<script>
    $(function () {
        $.bsCalendar.setDefaults({
            locale: 'de',
            startWeekOnSunday: false,
            rounded: 0,
            defaultColor: 'var(--bs-primary)',
            translations: {
                day: 'Tag',
                week: 'Woche',
                month: 'Monat',
                year: 'Jahr',
                today: 'Heute',
                appointment: 'Termin'
            },
            url: url,
            debug: true
        });
        const modal = $('#exampleModal');
        const calendarElement = $('#calendar');
        calendarElement.bsCalendar()
            .on('add.bs.calendar', function (event, data) {
                console.log(data);
                modal.find('input[name="title"]').val(null);
                modal.find('input[name="from_date"]').val(data.date);
                modal.find('input[name="to_date"]').val(data.date);
                modal.find('input[name="from_time"]').val(null);
                modal.find('input[name="to_time"]').val(null);
                modal.find('input[name="allDay"]').prop('checked', false).trigger('change');
                modal.find('textarea[name="description"]').val(null);
                modal.find('input[name="color"]').val(null);
                modal.find('input[name="link"]').val(null);
                modal.modal('show');
            })
            .on('edit.bs.calendar', function (event, appointment, $element) {
                event.preventDefault();
                console.log(appointment);
                const start = new Date(appointment.start);
                const end = new Date(appointment.end);
                const isAllDay = appointment.allDay;
                const title = appointment.title;
                const description = appointment.description;
                const color = appointment.color;
                const link = appointment.link;
                modal.find('input[name="title"]').val(title);
                modal.find('input[name="from_date"]').val(start.toISOString().split('T')[0]);
                modal.find('input[name="to_date"]').val(end.toISOString().split('T')[0]);
                modal.find('input[name="from_time"]').val(start.toISOString().split('T')[1].split('.')[0]);
                modal.find('input[name="to_time"]').val(end.toISOString().split('T')[1].split('.')[0]);
                modal.find('input[name="allDay"]').prop('checked', isAllDay).trigger('change');
                modal.find('textarea[name="description"]').val(description);
                modal.find('input[name="color"]').val(color);
                modal.find('input[name="link"]').val(link);
                modal.modal('show');
            }).on('view.bs.calendar', function (event, view) {
            console.log(view);
        }).on('click', '[data-method]', function (event) {
            event.preventDefault();
            switch ($(this).data('method')) {
                case 'destroy':
                    calendarElement.bsCalendar('destroy');
                    break;
                case 'clear':
                    calendarElement.bsCalendar('clear');
                    break;
                case 'refresh':
                    calendarElement.bsCalendar('refresh', {view: 'day'});
                    break;
                case 'setDate':
                    calendarElement.bsCalendar('setDate', {date: '1970-01-01', view: 'day'});
                    break;
                case 'setToday':
                    calendarElement.bsCalendar('setToday', 'day');
                    break;
                default:
                    break;
            }
        })

        function url(query) {
            const fromDate = new Date(`${query.fromDate}T00:00:00`);
            const toDate = new Date(`${query.toDate}T23:59:59`);
            const search = query.search;

            const appointments = generateRandomAppointments(`${query.fromDate}T00:00:00`, `${query.toDate}T23:59:59`, query.view).filter(appointment => {
                const appointmentStart = new Date(appointment.start);
                const appointmentEnd = new Date(appointment.end);

                return (
                    (appointmentStart >= fromDate && appointmentStart < toDate) || // Startzeit liegt im Bereich
                    (appointmentEnd > fromDate && appointmentEnd <= toDate) ||    // Endzeit liegt im Bereich
                    (appointmentStart <= fromDate && appointmentEnd >= toDate)    // Termin umspannt den Bereich
                );
            });
console.log(appointments);
            if (search) {
                return appointments.filter(appointment => {
                    return appointment.title.toLowerCase().includes(search.toLowerCase());
                });
            }
            return appointments;
        }

        function generateRandomAppointments(start, end, view) {
            const colors = [
                '#007bff',
                '#6c757d',
                '#28a745',
                '#ffc107',
                '#dc3545',
                '#17a2b8',
                '#343a40',
                '#6f42c1',
                '#0dcaf0',
            ];
            const appointments = [];
            const startDate = new Date(start);
            const endDate = new Date(end);
            let count = 0;
            if (view === 'month') {
                count = Math.floor(Math.random() * 61);
            }
            if (view === 'week') {
                count = Math.floor(Math.random() * 21);
            }
            if (view === 'day') {
                count = Math.floor(Math.random() * 6);
            }
            if (view === 'year') {
                count = Math.floor(Math.random() * 2);
            }
            if (view === 'search') {
                count = Math.floor(Math.random() * 21);
            }

            for (let i = 0; i < count; i++) {
                // set minute to 0, 30 or 45
                const startMinutesOptions = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55];
                const randomTimeStart = new Date(
                    startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime())
                );

                randomTimeStart.setMinutes(startMinutesOptions[Math.floor(Math.random() * startMinutesOptions.length)]);
                randomTimeStart.setSeconds(0); // Set seconds to 0
                randomTimeStart.setMilliseconds(0); // set milliseconds to 0

                const durationOptions = [45, 60, 90, 120, 240, 500];
                const randomDuration = durationOptions[Math.floor(Math.random() * durationOptions.length)];

                // calculate the end time based in the duration
                const randomTimeEnd = new Date(randomTimeStart.getTime() + randomDuration * 60000); // Endzeit berechnen
                // ensure that the end date is not outside the area
                if (randomTimeEnd > endDate) {
                    randomTimeEnd.setTime(endDate.getTime());
                }

                const description = `This is a randomly generated appointment description. The appointment is meant to provide useful information about the scheduled event. Details such as the purpose of the appointment, participants, or special instructions can typically be included here. Appointment #${i + 1} is designed to showcase how descriptions enhance context.`;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const link = 'https://github.com/ThomasDev-de/bs-calendar';

                // Termin erstellen
                const appointment = {
                    id: i + 1,
                    title: `Appointment ${i + 1}`,
                    description: description,
                    start: randomTimeStart.toISOString().replace('T', ' ').substring(0, 19),
                    end: randomTimeEnd.toISOString().replace('T', ' ').substring(0, 19),
                    allDay: i % 21 === 0,
                    color: color,
                    link: link
                }

                appointments.push(appointment);
            }

            return appointments;
        }


        $('#flexSwitchCheckDefaultAllDay').prop('checked', false)
            .on('change', function () {
                const isAllDay = $(this).prop('checked');
                // if (isAllDay) {
                $('.js-hide-on-all-day').toggle(!isAllDay);
                // }


            });
        $('#flexSwitchCheckTheme').prop('checked', false)
            .on('change', function () {
                const theme = $('html').attr('data-bs-theme') === 'light' ? 'dark' : 'light';
                $('html').attr('data-bs-theme', theme);
            });
    });
</script>
</body>
</html>
