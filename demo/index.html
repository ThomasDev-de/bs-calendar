<!doctype html>
<html lang="en" class="h-100 w-100" data-bs-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap Calendar Demo</title>
    <link href="../vendor/twbs/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../vendor/twbs/bootstrap-icons/font/bootstrap-icons.min.css" rel="stylesheet">
</head>
<body class="h-100 w-100">
<div class="d-flex justify-content-between align-items-center border-bottom border-5 px-5">
    <h1>$.fn.bsCalendar</h1>
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckTheme">
        <label class="form-check-label" for="flexSwitchCheckTheme">light / dark</label>
    </div>
</div>

<div id="calendar" data-sidebar-addons="#sidebarAddons" class="w-100 p-4" style="height: 800px">

</div>

<div id="sidebarAddons" class="mt-4">
    <h6 class="text-uppercase text-center border-bottom">sidebar addons</h6>
    <select class="form-select rounded-5 mb-3" name="user_id" aria-label="Default select example">
        <option value="1">User 1</option>
        <option value="2">User 2</option>
    </select>
    <select class="form-select rounded-5" name="type_id" aria-label="Default select example">
        <option value="1">Type 1</option>
        <option value="2">Type 2</option>
    </select>
</div>
<script src="../vendor/components/jquery/jquery.min.js"></script>

<script src="../vendor/twbs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../dist/bs-calendar.min.js"></script>
<script>
    $(function () {
        $.bsCalendar.setDefaults({
            locale: 'de',
            startWeekOnSunday: false,
            rounded: 5,
            translations: {
                day: 'Tag',
                week: 'Woche',
                month: 'Monat',
                year: 'Jahr',
                today: 'Heute',
            },
            url:url,
            debug: true
        });

        const calendarElement = $('#calendar');
        calendarElement.bsCalendar()
            .on('click-appointment.bs.calendar', function (event, appointment, $element) {
                event.preventDefault();
                $element.popover('hide');
                $element.removeClass('text-bg-light');
                // alert(appointment.title);
            }).on('view.bs.calendar', function (event, view) {
            console.log(view);
        }).on('change', '[name="user_id"], [name="type_id"]', function (event) {
            calendarElement.bsCalendar('load', {
                queryParams(query) {
                    query.user_id = $('[name="user_id"]').val();
                    query.type_id = $('[name="type_id"]').val();
                    return query;
                }
            });
        })

        function url(query) {
            const fromDate = new Date(`${query.fromDate}T00:00:00`);
            const toDate = new Date(`${query.toDate}T23:59:59`);

            return generateRandomAppointments(`${query.fromDate}T00:00:00`, `${query.toDate}T23:59:59`, query.view).filter(appointment => {
                const appointmentStart = new Date(appointment.start);
                const appointmentEnd = new Date(appointment.end);

                return (
                    (appointmentStart >= fromDate && appointmentStart < toDate) || // Startzeit liegt im Bereich
                    (appointmentEnd > fromDate && appointmentEnd <= toDate) ||    // Endzeit liegt im Bereich
                    (appointmentStart <= fromDate && appointmentEnd >= toDate)    // Termin umspannt den Bereich
                );
            });
        }

        function generateRandomAppointments(start, end, view) {
            const colors = [
                '#007bff',
                '#6c757d',
                '#28a745',
                '#ffc107',
                '#dc3545',
                '#17a2b8',
                '#343a40',
                '#6f42c1',
                '#0dcaf0',
            ];
            const appointments = [];
            const startDate = new Date(start);
            const endDate = new Date(end);
            let count = 0;
            if (view === 'month') {
                count = Math.floor(Math.random() * 51);
            }
            if (view === 'week') {
                count = Math.floor(Math.random() * 101);
            }
            if (view === 'day') {
                count = Math.floor(Math.random() * 21);
            }
            if (view === 'year') {
                count = Math.floor(Math.random() * 201);
            }

            for (let i = 0; i < count; i++) {
                // set minute to 0, 30 or 45
                const startMinutesOptions = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55];
                const randomTimeStart = new Date(
                    startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime())
                );

                randomTimeStart.setMinutes(startMinutesOptions[Math.floor(Math.random() * startMinutesOptions.length)]);
                randomTimeStart.setSeconds(0); // Set seconds to 0
                randomTimeStart.setMilliseconds(0); // set milliseconds to 0

                const durationOptions = [45, 60, 90, 120];
                const randomDuration = durationOptions[Math.floor(Math.random() * durationOptions.length)];

                // calculate the end time based in the duration
                const randomTimeEnd = new Date(randomTimeStart.getTime() + randomDuration * 60000); // Endzeit berechnen
                // ensure that the end date is not outside the area
                if (randomTimeEnd > endDate) {
                    randomTimeEnd.setTime(endDate.getTime());
                }

                const description = `This is a randomly generated appointment description. The appointment is meant to provide useful information about the scheduled event. Details such as the purpose of the appointment, participants, or special instructions can typically be included here. Appointment #${i + 1} is designed to showcase how descriptions enhance context.`;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const link = 'https://github.com/ThomasDev-de/bs-calendar';

                // Termin erstellen
                const appointment = {
                    id: i + 1,
                    title: `Appointment ${i + 1}`,
                    description: description,
                    start: randomTimeStart.toISOString().replace('T', ' ').substring(0, 19),
                    end: randomTimeEnd.toISOString().replace('T', ' ').substring(0, 19),
                    allDay: i % 21 === 0,
                    color: color,
                    link: link
                }

                appointments.push(appointment);
            }

            return appointments;
        }


        $('#flexSwitchCheckTheme').prop('checked', false)
            .on('change', function () {
                const theme = $('html').attr('data-bs-theme') === 'light' ? 'dark' : 'light';
                $('html').attr('data-bs-theme', theme);
            });
    });
</script>
</body>
</html>
